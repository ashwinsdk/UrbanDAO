<div class="tax-assessment">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <h1>Create Tax Assessment</h1>
      <p>Create and issue new tax assessments to citizens</p>
    </div>
    <button class="back-btn" routerLink="/tax-collector">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </button>
  </header>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Content Area -->
  <div *ngIf="!loading" class="assessment-content">
    <!-- Success Message -->
    <div *ngIf="success" class="success-container">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2>Tax Assessment Created</h2>
      <p>The tax assessment has been successfully created and issued to the citizen.</p>
      <div class="buttons">
        <button class="secondary-btn" (click)="resetForm()">Create Another</button>
        <button class="primary-btn" routerLink="/tax-collector">Return to Dashboard</button>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
      <i class="fas fa-exclamation-circle"></i>
      <span>{{ error }}</span>
      <button class="close-btn" (click)="error = null">Ã—</button>
    </div>

    <!-- Assessment Form -->
    <form *ngIf="!success" [formGroup]="assessmentForm" (ngSubmit)="onSubmit()" class="assessment-form">
      <div class="form-container">
        <!-- Left Column -->
        <div class="form-column">
          <!-- Citizen Selector -->
          <div class="form-group">
            <label for="citizenSearch">Select Citizen <span class="required">*</span></label>
            <div class="citizen-search">
              <input 
                type="text"
                id="citizenSearch"
                [value]="searchQuery"
                (input)="onSearchInput($event)"
                placeholder="Search by name, address or property ID"
                autocomplete="off"
              >
              <i class="fas fa-search"></i>
              
              <!-- Dropdown List -->
              <div *ngIf="showCitizensList && searchQuery.length > 0" class="citizens-dropdown">
                <div *ngIf="citizensLoading" class="loading-citizens">
                  <div class="mini-spinner"></div>
                  <span>Loading citizens...</span>
                </div>
                
                <div *ngIf="!citizensLoading && filteredCitizens.length === 0" class="no-citizens">
                  <i class="fas fa-user-slash"></i>
                  <span>No citizens found matching "{{ searchQuery }}"</span>
                </div>
                
                <ul *ngIf="!citizensLoading && filteredCitizens.length > 0" class="citizens-list">
                  <li *ngFor="let citizen of filteredCitizens" (click)="selectCitizen(citizen)" class="citizen-item">
                    <div class="citizen-info">
                      <div class="name">{{ citizen.name || 'Unknown' }}</div>
                      <div class="address">{{ formatAddress(citizen.address) }}</div>
                    </div>
                    <div class="property-info" *ngIf="citizen.propertyId">
                      <div class="property-id">ID: {{ citizen.propertyId }}</div>
                      <div class="location" *ngIf="citizen.location">{{ citizen.location }}</div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
            
            <!-- Hidden input for form validation -->
            <input type="hidden" formControlName="citizenAddress">
            <div *ngIf="assessmentForm.get('citizenAddress')?.invalid && assessmentForm.get('citizenAddress')?.touched" class="error-text">
              Citizen selection is required
            </div>
          </div>
          
          <!-- Property ID -->
          <div class="form-group">
            <label for="propertyId">Property ID <span class="required">*</span></label>
            <input 
              type="text" 
              id="propertyId" 
              formControlName="propertyId" 
              placeholder="Enter property ID"
            >
            <div *ngIf="assessmentForm.get('propertyId')?.invalid && assessmentForm.get('propertyId')?.touched" class="error-text">
              Property ID is required
            </div>
          </div>
          
          <!-- Amount -->
          <div class="form-group">
            <label for="amount">Assessment Amount (ETH) <span class="required">*</span></label>
            <input 
              type="number" 
              id="amount" 
              formControlName="amount" 
              placeholder="Enter amount in ETH"
              min="0.001"
              step="0.001"
            >
            <div *ngIf="assessmentForm.get('amount')?.invalid && assessmentForm.get('amount')?.touched" class="error-text">
              <span *ngIf="assessmentForm.get('amount')?.errors?.['required']">Amount is required</span>
              <span *ngIf="assessmentForm.get('amount')?.errors?.['min']">Amount must be at least 0.001 ETH</span>
            </div>
          </div>
          
          <!-- Year and Quarter -->
          <div class="form-row">
            <div class="form-group half">
              <label for="year">Year <span class="required">*</span></label>
              <input 
                type="number" 
                id="year" 
                formControlName="year" 
                placeholder="Enter year"
              >
            </div>
            
            <div class="form-group half">
              <label for="quarter">Quarter <span class="required">*</span></label>
              <select id="quarter" formControlName="quarter">
                <option [value]="1">Q1 (Jan-Mar)</option>
                <option [value]="2">Q2 (Apr-Jun)</option>
                <option [value]="3">Q3 (Jul-Sep)</option>
                <option [value]="4">Q4 (Oct-Dec)</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Right Column -->
        <div class="form-column">
          <!-- Due Date -->
          <div class="form-group">
            <label for="dueDate">Due Date <span class="required">*</span></label>
            <input 
              type="date" 
              id="dueDate" 
              formControlName="dueDate" 
            >
            <div *ngIf="assessmentForm.get('dueDate')?.invalid && assessmentForm.get('dueDate')?.touched" class="error-text">
              Due date is required
            </div>
          </div>
          
          <!-- Description -->
          <div class="form-group">
            <label for="description">Assessment Description <span class="required">*</span></label>
            <textarea 
              id="description" 
              formControlName="description" 
              placeholder="Enter a detailed description of this tax assessment"
              rows="4"
            ></textarea>
            <div *ngIf="assessmentForm.get('description')?.invalid && assessmentForm.get('description')?.touched" class="error-text">
              <span *ngIf="assessmentForm.get('description')?.errors?.['required']">Description is required</span>
              <span *ngIf="assessmentForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</span>
            </div>
          </div>
          
          <!-- Penalty Settings -->
          <div class="form-row">
            <div class="form-group half">
              <label for="lateFee">Late Fee (ETH)</label>
              <input 
                type="number" 
                id="lateFee" 
                formControlName="lateFee" 
                placeholder="Enter late fee"
                min="0"
                step="0.001"
              >
            </div>
            
            <div class="form-group half">
              <label for="penaltyRate">Penalty Rate (%)</label>
              <input 
                type="number" 
                id="penaltyRate" 
                formControlName="penaltyRate" 
                placeholder="Enter penalty rate"
                min="0"
                max="100"
              >
            </div>
          </div>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="secondary-btn" (click)="resetForm()">Reset Form</button>
        <button 
          type="submit" 
          class="primary-btn" 
          [disabled]="assessmentForm.invalid || submitting"
        >
          <span *ngIf="!submitting">Create Assessment</span>
          <span *ngIf="submitting">
            <div class="mini-spinner"></div> Creating...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
